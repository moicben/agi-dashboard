{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///Users/ben/Documents/Tech/vnc-viewer/pages/api/instances.js"],"sourcesContent":["export default async function handler(req, res) {\n  try {\n    // Configuration depuis les variables d'environnement\n    const INCUS_API_URL = process.env.INCUS_API_URL;\n    const INCUS_API_KEY = process.env.INCUS_API_KEY;\n    const IP_PREFIX = process.env.IP_PREFIX;\n\n    // Vérifier que toutes les variables d'environnement nécessaires sont définies\n    const missingVars = [];\n    if (!INCUS_API_URL) missingVars.push('INCUS_API_URL');\n    if (!INCUS_API_KEY) missingVars.push('INCUS_API_KEY');\n    if (!IP_PREFIX) missingVars.push('IP_PREFIX');\n\n    if (missingVars.length > 0) {\n      console.error('Variables d\\'environnement manquantes:', missingVars.join(', '));\n      res.setHeader('Access-Control-Allow-Origin', '*');\n      res.setHeader('Content-Type', 'application/json');\n      res.status(500).json({\n        error: 'Configuration incomplète',\n        message: `Variables d'environnement manquantes: ${missingVars.join(', ')}. Veuillez les ajouter dans votre fichier .env.`,\n        missingVariables: missingVars\n      });\n      return;\n    }\n\n    // Faire la requête à l'API Incus depuis le serveur (pas de problème CORS)\n    const response = await fetch(INCUS_API_URL, {\n      headers: {\n        'x-api-key': INCUS_API_KEY\n      }\n    });\n\n    if (!response.ok) {\n      throw new Error(`Erreur HTTP: ${response.status}`);\n    }\n\n    const data = await response.json();\n\n    // Traiter les données de l'API Incus\n    // Format: [{\"name\":\"scheduler\",\"type\":\"container\",\"status\":\"Running\",\"ips\":[{\"interface\":\"eth0\",\"address\":\"10.225.44.181\"}]}, ...]\n    let containers = [];\n\n    if (Array.isArray(data)) {\n      containers = data.map(instance => {\n        // Extraire le suffixe IP depuis l'IP complète\n        let ipSuffix = null;\n        let ip = null;\n\n        if (instance.ips && Array.isArray(instance.ips) && instance.ips.length > 0) {\n          // Chercher l'IP qui correspond au préfixe\n          const ipObj = instance.ips.find(ipItem =>\n            ipItem.address && ipItem.address.startsWith(IP_PREFIX)\n          );\n          if (ipObj && ipObj.address) {\n            ip = ipObj.address;\n            ipSuffix = ip.replace(IP_PREFIX, '');\n          }\n        }\n\n        // Si pas d'IP trouvée, essayer d'extraire depuis le nom (ex: booker-181 -> 181)\n        if (!ipSuffix && instance.name) {\n          const match = instance.name.match(/(\\d+)$/);\n          if (match) {\n            ipSuffix = match[1];\n            ip = `${IP_PREFIX}${ipSuffix}`;\n          }\n        }\n\n        return {\n          name: instance.name,\n          ipSuffix: ipSuffix,\n          ip: ip,\n          status: instance.status,\n          type: instance.type\n        };\n      }).filter(container => container.ipSuffix);\n    }\n\n    res.setHeader('Access-Control-Allow-Origin', '*');\n    res.setHeader('Content-Type', 'application/json');\n    res.status(200).json({\n      containers: containers,\n      count: containers.length\n    });\n\n  } catch (error) {\n    console.error('Erreur:', error);\n    res.setHeader('Access-Control-Allow-Origin', '*');\n    res.status(500).json({\n      error: 'Erreur lors de la récupération des containers',\n      message: error.message\n    });\n  }\n}\n"],"names":[],"mappings":";;;;AAAe,eAAe,QAAQ,GAAG,EAAE,GAAG;IAC5C,IAAI;QACF,qDAAqD;QACrD,MAAM,gBAAgB,QAAQ,GAAG,CAAC,aAAa;QAC/C,MAAM,gBAAgB,QAAQ,GAAG,CAAC,aAAa;QAC/C,MAAM,YAAY,QAAQ,GAAG,CAAC,SAAS;QAEvC,8EAA8E;QAC9E,MAAM,cAAc,EAAE;QACtB,IAAI,CAAC,eAAe,YAAY,IAAI,CAAC;QACrC,IAAI,CAAC,eAAe,YAAY,IAAI,CAAC;QACrC,IAAI,CAAC,WAAW,YAAY,IAAI,CAAC;QAEjC,IAAI,YAAY,MAAM,GAAG,GAAG;YAC1B,QAAQ,KAAK,CAAC,0CAA0C,YAAY,IAAI,CAAC;YACzE,IAAI,SAAS,CAAC,+BAA+B;YAC7C,IAAI,SAAS,CAAC,gBAAgB;YAC9B,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBACnB,OAAO;gBACP,SAAS,CAAC,sCAAsC,EAAE,YAAY,IAAI,CAAC,MAAM,+CAA+C,CAAC;gBACzH,kBAAkB;YACpB;YACA;QACF;QAEA,0EAA0E;QAC1E,MAAM,WAAW,MAAM,MAAM,eAAe;YAC1C,SAAS;gBACP,aAAa;YACf;QACF;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,IAAI,MAAM,CAAC,aAAa,EAAE,SAAS,MAAM,EAAE;QACnD;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAEhC,qCAAqC;QACrC,mIAAmI;QACnI,IAAI,aAAa,EAAE;QAEnB,IAAI,MAAM,OAAO,CAAC,OAAO;YACvB,aAAa,KAAK,GAAG,CAAC,CAAA;gBACpB,8CAA8C;gBAC9C,IAAI,WAAW;gBACf,IAAI,KAAK;gBAET,IAAI,SAAS,GAAG,IAAI,MAAM,OAAO,CAAC,SAAS,GAAG,KAAK,SAAS,GAAG,CAAC,MAAM,GAAG,GAAG;oBAC1E,0CAA0C;oBAC1C,MAAM,QAAQ,SAAS,GAAG,CAAC,IAAI,CAAC,CAAA,SAC9B,OAAO,OAAO,IAAI,OAAO,OAAO,CAAC,UAAU,CAAC;oBAE9C,IAAI,SAAS,MAAM,OAAO,EAAE;wBAC1B,KAAK,MAAM,OAAO;wBAClB,WAAW,GAAG,OAAO,CAAC,WAAW;oBACnC;gBACF;gBAEA,gFAAgF;gBAChF,IAAI,CAAC,YAAY,SAAS,IAAI,EAAE;oBAC9B,MAAM,QAAQ,SAAS,IAAI,CAAC,KAAK,CAAC;oBAClC,IAAI,OAAO;wBACT,WAAW,KAAK,CAAC,EAAE;wBACnB,KAAK,GAAG,YAAY,UAAU;oBAChC;gBACF;gBAEA,OAAO;oBACL,MAAM,SAAS,IAAI;oBACnB,UAAU;oBACV,IAAI;oBACJ,QAAQ,SAAS,MAAM;oBACvB,MAAM,SAAS,IAAI;gBACrB;YACF,GAAG,MAAM,CAAC,CAAA,YAAa,UAAU,QAAQ;QAC3C;QAEA,IAAI,SAAS,CAAC,+BAA+B;QAC7C,IAAI,SAAS,CAAC,gBAAgB;QAC9B,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,YAAY;YACZ,OAAO,WAAW,MAAM;QAC1B;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,WAAW;QACzB,IAAI,SAAS,CAAC,+BAA+B;QAC7C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OAAO;YACP,SAAS,MAAM,OAAO;QACxB;IACF;AACF"}}]
}